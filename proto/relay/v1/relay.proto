syntax = "proto3";

package continuum.relay.v1;

// RelayService provides bidirectional streaming for relay tunnel communication.
service RelayService {
  // Tunnel establishes a bidirectional stream for relay communication.
  rpc Tunnel(stream Envelope) returns (stream Envelope);
}

// Envelope wraps all message types exchanged over the relay connection.
message Envelope {
  oneof msg {
    Register register = 1;
    OpenTunnel open_tunnel = 2;
    TunnelAccepted accepted = 3;
    TunnelRejected rejected = 4;
    Data data = 5;
    Close close = 6;
  }
}

// Register identifies the connecting party to the relay.
message Register {
  enum Kind {
    KIND_UNSPECIFIED = 0;
    DAEMON = 1;
    CLIENT = 2;
  }

  // The type of connection (daemon or client).
  Kind kind = 1;

  // Required when kind=DAEMON. The unique identifier for this daemon.
  string daemon_id = 2;

  // Optional when kind=CLIENT. If not provided, the relay assigns one.
  string client_id = 3;
}

// OpenTunnel requests a new tunnel to a specific daemon.
message OpenTunnel {
  enum Target {
    TARGET_UNSPECIFIED = 0;
    ENROLLMENT = 1;
    MAIN = 2;
  }

  // Unique identifier for this tunnel.
  string tunnel_id = 1;

  // The daemon to connect to.
  string daemon_id = 2;

  // Which service on the daemon to connect to.
  Target target = 3;
}

// TunnelAccepted confirms that the daemon accepted the tunnel request.
message TunnelAccepted {
  string tunnel_id = 1;
}

// TunnelRejected indicates the daemon rejected the tunnel request.
message TunnelRejected {
  string tunnel_id = 1;
  string reason = 2;
}

// Data carries payload bytes for an established tunnel.
message Data {
  string tunnel_id = 1;
  bytes payload = 2;
}

// Close terminates a tunnel.
message Close {
  string tunnel_id = 1;
  string reason = 2;
}
